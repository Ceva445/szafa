{% extends "base.html" %}
{% block title %}Nowe DW{% endblock %}
{% block page_title %}Nowe DW{% endblock %}
{% block content %}
<div class="card">
  <form method="post">
    {% csrf_token %}
    <div class="filter-row">
      <label>Pracownik
        <select name="employee" {% if errors.employee %}style="border-color:#ef4444;"{% endif %}>
          <option value="">-- wybierz --</option>
          {% for e in employees %}
            <option value="{{ e.id }}" 
                  {% if request.POST.employee == e.id|stringformat:"s" or selected_employee == e.id|stringformat:"s" %}selected{% endif %}>
              {{ e.last_name }} {{ e.first_name }} ({{ e.card_number }})
            </option>
          {% endfor %}
        </select>
        {% if errors.employee %}<div style="color:#ef4444;font-size:12px;margin-top:4px;">{{ errors.employee }}</div>{% endif %}
      </label>

      <label>Data wystawienia
        <input type="date" name="issue_date" value="{{ request.POST.issue_date|default:today }}" {% if errors.issue_date %}style="border-color:#ef4444;"{% endif %}>
        {% if errors.issue_date %}<div style="color:#ef4444;font-size:12px;margin-top:4px;">{{ errors.issue_date }}</div>{% endif %}
      </label>
    </div>

    <hr>
    <h4>Pozycje</h4>
    {% if errors.items and not errors.item_errors and not errors.employee and not errors.recipient and not errors.issue_date %}
      <div style="color:#ef4444;margin-bottom:6px;">{{ errors.items }}</div>
    {% endif %}
    {% if errors.item_errors %}
      <ul style="color:#ef4444;margin-bottom:8px;font-size:13px;">
        {% for err in errors.item_errors %}
          <li>{{ err }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <div id="items">
      {% if items %}
        {% for pid, qty, size, price, note, stock_qty in items %}
          <div class="item-row" data-index="{{ forloop.counter0 }}" style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
            <select name="product_id[]" class="product-select">
              <option value="">-- produkt --</option>
              {% for p in products %}
                <option value="{{ p.id }}" 
                        data-size="{{ p.size|default:'' }}" 
                        data-price="{{ p.unit_price }}"
                        data-stock-qty="{{ p.stock_qty }}"
                  {% if p.id|stringformat:"s" == pid %}selected{% endif %}>
                  {{ p.code }} — {{ p.name }}
                </option>
              {% endfor %}
            </select>
            <input name="quantity[]" class="small" placeholder="Ilość" value="{{ qty }}" />
            <input name="size[]" class="small size-field" placeholder="Rozmiar" readonly value="{{ size }}" />
            <input name="unit_price[]" class="small price-field" placeholder="Cena" readonly value="{{ price }}" />
            <input name="stock_qty[]" class="small stock-field" placeholder="Na stanie" readonly value="{{ stock_qty }}" />
            <input name="notes[]" class="small" placeholder="Uwagi" value="{{ note }}" />
            <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
          </div>
        {% endfor %}
      {% else %}
        <!-- Перший ряд за замовчуванням -->
        <div class="item-row" data-index="0" style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
          <select name="product_id[]" class="product-select">
            <option value="">-- produkt --</option>
            {% for p in products %}
              <option value="{{ p.id }}"
                      data-size="{{ p.size|default:'' }}"
                      data-price="{{ p.unit_price }}"
                      data-stock-qty="{{ p.stock_qty }}">
                {{ p.code }} — {{ p.name }}
              </option>
            {% endfor %}
          </select>
          <input name="quantity[]" class="small" placeholder="Ilość" />
          <input name="size[]" class="small size-field" placeholder="Rozmiar" readonly />
          <input name="unit_price[]" class="small price-field" placeholder="Cena" readonly />
          <input name="stock_qty[]" class="small stock-field" placeholder="Na stanie" readonly />
          <input name="notes[]" class="small" placeholder="Uwagi" />
          <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
        </div>
      {% endif %}
    </div>

    <div style="margin-top:8px;">
      <button type="button" class="btn small" onclick="addRow()">Dodaj pozycję</button>
      <button class="btn primary small">Zapisz DW</button>
    </div>
  </form>
</div>

{% block scripts %}
<script>
function updateProductFields(selectElement) {
  const row = selectElement.closest('.item-row');
  const sizeField = row.querySelector('.size-field');
  const priceField = row.querySelector('.price-field');
  const stockField = row.querySelector('.stock-field');
  
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  
  if (selectedOption && selectedOption.value) {
    const size = selectedOption.getAttribute('data-size') || '';
    const price = selectedOption.getAttribute('data-price') || '';
    const stockQty = selectedOption.getAttribute('data-stock-qty') || '0';
    
    sizeField.value = size;
    priceField.value = price;
    stockField.value = stockQty;
  } else {
    // Якщо продукт не вибрано - очищаємо поля
    sizeField.value = '';
    priceField.value = '';
    stockField.value = '';
  }
}

function addRow(){
  const container = document.getElementById('items');
  const index = container.children.length;
  
  const newRow = document.createElement('div');
  newRow.className = 'item-row';
  newRow.setAttribute('data-index', index);
  newRow.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:6px;';
  
  newRow.innerHTML = `
    <select name="product_id[]" class="product-select">
      <option value="">-- produkt --</option>
      {% for p in products %}
        <option value="{{ p.id }}" 
                data-size="{{ p.size|default:'' }}" 
                data-price="{{ p.unit_price }}"
                data-stock-qty="{{ p.stock_qty }}">
          {{ p.code }} — {{ p.name }}
        </option>
      {% endfor %}
    </select>
    <input name="quantity[]" class="small" placeholder="Ilość" />
    <input name="size[]" class="small size-field" placeholder="Rozmiar" readonly />
    <input name="unit_price[]" class="small price-field" placeholder="Cena" readonly />
    <input name="stock_qty[]" class="small stock-field" placeholder="Na stanie" readonly />
    <input name="notes[]" class="small" placeholder="Uwagi" />
    <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
  `; 
  container.appendChild(newRow);

  const productSelect = newRow.querySelector('.product-select');
  $(productSelect).select2({
    placeholder: "-- produkt --",
    allowClear: true,
    width: 'resolve'
  });

  $(productSelect).on('change', function() {
    updateProductFields(this);
  });
}

function removeRow(btn){
  const row = btn.closest('.item-row');
  if(row) {
    const select = row.querySelector('.product-select');
    if (select && $(select).data('select2')) {
      $(select).select2('destroy');
    }
    row.remove();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const employeeSelect = document.querySelector('select[name="employee"]');
  if (employeeSelect) {
    $(employeeSelect).select2({
      placeholder: "-- wybierz --",
      allowClear: true,
      width: '100%'
    });
  }

  document.querySelectorAll('.product-select').forEach(select => {
    $(select).select2({
      placeholder: "-- produkt --",
      allowClear: true,
      width: 'resolve'
    });

    $(select).on('change', function() {
      updateProductFields(this);
    });

    if (select.value) {
      updateProductFields(select);
    }
  });
});
</script>
{% endblock %}
{% endblock %}