{% extends "base.html" %}
{% block title %}Nowe PZ{% endblock %}
{% block page_title %}Nowe PZ{% endblock %}
{% block content %}
<div class="card">
  <form method="post">
    {% csrf_token %}
    <div class="filter-row">
      <label>Dostawca
        <select name="supplier" {% if errors.supplier %}style="border-color:#ef4444;"{% endif %}>
          <option value="">-- wybierz --</option>
          {% for s in suppliers %}
            <option value="{{ s.id }}" {% if request.POST.supplier == s.id|stringformat:"s" %}selected{% endif %}>
              {{ s.name }}
            </option>
          {% endfor %}
        </select>
        {% if errors.supplier %}<div style="color:#ef4444;font-size:12px;margin-top:4px;">{{ errors.supplier }}</div>{% endif %}
      </label>

      <label>Odbiorca
        <select name="recipient" {% if errors.recipient %}style="border-color:#ef4444;"{% endif %}>
          <option value="">-- wybierz --</option>
          {% for c in companies %}
            <option value="{{ c.id }}" {% if request.POST.recipient == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.name }}
            </option>
          {% endfor %}
        </select>
        {% if errors.recipient %}<div style="color:#ef4444;font-size:12px;margin-top:4px;">{{ errors.recipient }}</div>{% endif %}
      </label>

      <label>Data wystawienia
        <input type="date" name="issue_date" value="{{ request.POST.issue_date|default:today }}" {% if errors.issue_date %}style="border-color:#ef4444;"{% endif %}>
        {% if errors.issue_date %}<div style="color:#ef4444;font-size:12px;margin-top:4px;">{{ errors.issue_date }}</div>{% endif %}
      </label>
    </div>

    <hr>
    <h4>Pozycje</h4>
    {% if errors.items and not errors.item_errors and not errors.employee and not errors.recipient and not errors.issue_date %}
      <div style="color:#ef4444;margin-bottom:6px;">{{ errors.items }}</div>
    {% endif %}
    {% if errors.item_errors %}
      <ul style="color:#ef4444;margin-bottom:8px;font-size:13px;">
        {% for err in errors.item_errors %}
          <li>{{ err }}</li>
        {% endfor %}
      </ul>
    {% endif %}

    <div id="items">
      {% if items %}
        {% for pid, qty, size, price, note in items %}
          <div class="item-row" style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
            <select name="product_id[]" class="product-select">
              <option value="">-- produkt --</option>
              {% for p in products %}
                <option value="{{ p.id }}" data-size="{{ p.size|default:'' }}" data-price="{{ p.unit_price }}" {% if p.id|stringformat:"s" == pid %}selected{% endif %}>
                  {{ p.code }} — {{ p.name }}
                </option>
              {% endfor %}
            </select>
            <input name="quantity[]" class="small" placeholder="Ilość" value="{{ qty }}" />
            <input name="size[]" class="small size-field" placeholder="Rozmiar" readonly value="{{ size }}" />
            <input name="unit_price[]" class="small price-field" placeholder="Cena" value="{{ price }}" />
            <input name="notes[]" class="small" placeholder="Uwagi" value="{{ note }}" />
            <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
          </div>
        {% endfor %}
      {% else %}
        <div class="item-row" style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
          <select name="product_id[]" class="product-select">
            <option value="">-- produkt --</option>
            {% for p in products %}
              <option value="{{ p.id }}" data-size="{{ p.size|default:'' }}" data-price="{{ p.unit_price }}">
                {{ p.code }} — {{ p.name }}
              </option>
            {% endfor %}
          </select>
          <input name="quantity[]" class="small" placeholder="Ilość" />
          <input name="size[]" class="small size-field" placeholder="Rozmiar" readonly />
          <input name="unit_price[]" class="small price-field" placeholder="Cena" />
          <input name="notes[]" class="small" placeholder="Uwagi" />
          <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
        </div>
      {% endif %}
    </div>

    <div style="margin-top:8px;">
      <button type="button" class="btn small" onclick="addRow()">Dodaj pozycję</button>
      <button class="btn primary small">Zapisz PZ</button>
    </div>
  </form>
</div>

{% block scripts %}
<script>
function updateProductFields(selectElement) {
  const row = selectElement.closest('.item-row');
  const sizeField = row.querySelector('.size-field');
  const priceField = row.querySelector('.price-field');
  
  const selectedOption = selectElement.options[selectElement.selectedIndex];
  
  if (selectedOption && selectedOption.value) {
    const size = selectedOption.getAttribute('data-size') || '';
    const price = selectedOption.getAttribute('data-price') || '';
    
    sizeField.value = size;
    priceField.value = price;
  } else {
    sizeField.value = '';
    priceField.value = '';
  }
}

function addRow() {
  const container = document.getElementById('items');
  const newRow = document.createElement('div');
  newRow.className = 'item-row';
  newRow.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:6px;';
  newRow.innerHTML = `
    <select name="product_id[]" class="product-select">
      <option value="">-- produkt --</option>
      {% for p in products %}
        <option value="{{ p.id }}" data-size="{{ p.size|default:'' }}" data-price="{{ p.unit_price }}">
          {{ p.code }} — {{ p.name }}
        </option>
      {% endfor %}
    </select>
    <input name="quantity[]" class="small" placeholder="Ilość" />
    <input name="size[]" class="small size-field" placeholder="Rozmiar" readonly />
    <input name="unit_price[]" class="small price-field" placeholder="Cena" />
    <input name="notes[]" class="small" placeholder="Uwagi" />
    <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
  `;
  container.appendChild(newRow);

  const productSelect = newRow.querySelector('.product-select');
  
  $(productSelect).select2({
    placeholder: "-- produkt --",
    allowClear: true,
    width: 'resolve'
  });

  $(productSelect).on('change', function() {
    updateProductFields(this);
  });
}

function removeRow(btn) {
  const row = btn.closest('.item-row');
  if (row) {
    const select = row.querySelector('.product-select');
    if (select && $(select).data('select2')) {
      $(select).select2('destroy');
    }
    row.remove();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const supplierSelect = document.querySelector('select[name="supplier"]');
  if (supplierSelect) {
    $(supplierSelect).select2({
      placeholder: "-- wybierz --",
      allowClear: true,
      width: '100%'
    });
  }

  const recipientSelect = document.querySelector('select[name="recipient"]');
  if (recipientSelect) {
    $(recipientSelect).select2({
      placeholder: "-- wybierz --",
      allowClear: true,
      width: '100%'
    });
  }

  document.querySelectorAll('.product-select').forEach(select => {
    $(select).select2({
      placeholder: "-- produkt --",
      allowClear: true,
      width: 'resolve'
    });

    $(select).on('change', function() {
      updateProductFields(this);
    });

    if (select.value) {
      updateProductFields(select);
    }
  });
});
</script>
{% endblock %}
{% endblock %}