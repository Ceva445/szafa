{% extends "base.html" %}
{% block title %}Nowe PZ{% endblock %}
{% block page_title %}Nowe PZ{% endblock %}
{% block content %}
<div class="card">
  <form method="post">
    {% csrf_token %}
    <div class="filter-row">
      <label>Dostawca
        <select name="supplier">
          <option value="">-- wybierz --</option>
          {% for s in suppliers %}
          <option value="{{ s.id }}">{{ s.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Odbiorca
        <select name="recipient">
          <option value="">-- wybierz --</option>
          {% for c in companies %}
          <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>Data wystawienia
        <input type="date" name="issue_date" value="{{ form.issue_date|default:today }}">
      </label>
    </div>

    <hr>
    <h4>Pozycje</h4>
    <div id="items">
      <div class="item-row" style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
        <select name="product_id[]" class="product-select">
          <option value="">-- produkt --</option>
          {% for p in products %}
          <option value="{{ p.id }}" 
                  data-size="{{ p.size|default:'' }}" 
                  data-price="{{ p.unit_price }}">
            {{ p.code }} — {{ p.name }}
          </option>
          {% endfor %}
        </select>
        <input name="quantity[]" placeholder="Ilość" class="small" />
        <input name="size[]" placeholder="Rozmiar" class="small size-field" readonly />
        <input name="unit_price[]" placeholder="Cena jedn." class="small price-field" />
        <input name="notes[]" placeholder="Uwagi" class="small" />
        <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
      </div>
    </div>

    <div style="margin-top:8px;">
      <button type="button" class="btn small" onclick="addRow()">Dodaj pozycję</button>
      <button class="btn primary small">Zapisz PZ</button>
    </div>
  </form>
</div>

{% block scripts %}
<script>
// Створюємо об'єкт для зберігання даних про продукти
const productsData = {
  {% for p in products %}
  "{{ p.id }}": {
    size: "{{ p.size|default:'' }}",
    price: "{{ p.unit_price }}"
  },
  {% endfor %}
};

function addRow(){
  const container = document.getElementById('items');
  const newIndex = container.children.length;
  
  const newRow = document.createElement('div');
  newRow.className = 'item-row';
  newRow.style.cssText = 'display:flex;gap:8px;align-items:center;margin-bottom:6px;';
  
  newRow.innerHTML = `
    <select name="product_id[]" class="product-select">
      <option value="">-- produkt --</option>
      {% for p in products %}
      <option value="{{ p.id }}" 
              data-size="{{ p.size|default:'' }}" 
              data-price="{{ p.unit_price }}">
        {{ p.code }} — {{ p.name }}
      </option>
      {% endfor %}
    </select>
    <input name="quantity[]" placeholder="Ilość" class="small" />
    <input name="size[]" placeholder="Rozmiar" class="small size-field" readonly />
    <input name="unit_price[]" placeholder="Cena jedn." class="small price-field" />
    <input name="notes[]" placeholder="Uwagi" class="small" />
    <button type="button" class="btn ghost small" onclick="removeRow(this)">Usuń</button>
  `;
  
  container.appendChild(newRow);
  
  // Додаємо обробник події для нового рядка
  const productSelect = newRow.querySelector('.product-select');
  productSelect.addEventListener('change', handleProductChange);
}

function removeRow(btn){
  const row = btn.closest('.item-row');
  if(row) row.remove();
}

function handleProductChange(event) {
  const row = event.target.closest('.item-row');
  const productId = event.target.value;
  const sizeField = row.querySelector('.size-field');
  const priceField = row.querySelector('.price-field');
  
  if (productId && productsData[productId]) {
    const product = productsData[productId];
    sizeField.value = product.size || '';
    priceField.value = product.price || '';
  } else {
    sizeField.value = '';
    priceField.value = '';
  }
}

// Ініціалізація обробників подій для існуючих рядків
document.addEventListener('DOMContentLoaded', function() {
  const productSelects = document.querySelectorAll('.product-select');
  productSelects.forEach(select => {
    select.addEventListener('change', handleProductChange);
  });
});
</script>
{% endblock %}
{% endblock %}